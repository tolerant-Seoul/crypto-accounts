# BIP-32: Hierarchical Deterministic Wallets

BIP-32는 하나의 시드(Seed)에서 무한한 키를 생성할 수 있는 계층적 결정론적(HD) 지갑의 표준입니다.

## 핵심 개념

### 계층적 키 구조

```
        시드 (Seed)
            │
            ▼
      ┌─────────────┐
      │  마스터 키   │  ← 모든 키의 뿌리
      └─────────────┘
            │
    ┌───────┼───────┐
    ▼       ▼       ▼
  자식0   자식1   자식2  ← 각각이 또 부모가 될 수 있음
    │       │
   ┌┴┐     ┌┴┐
   ▼ ▼     ▼ ▼
  손자들   손자들  ← 트리처럼 무한히 확장
```

## 왜 BIP-32가 필요한가?

### 이전 방식의 문제점

```
지갑에 100개 주소가 필요하면?
→ 100개의 개인키를 각각 백업해야 함
→ 하나라도 잃어버리면 해당 자금 손실
```

### BIP-32 방식의 장점

```
시드 하나만 백업하면?
→ 모든 키를 다시 생성할 수 있음
→ 12/24개 단어(니모닉)만 안전하게 보관
```

## 주요 특징

### 1. 계층적 구조 (Hierarchical Structure)
키가 트리 구조로 조직되어, 부모 키에서 자식 키를 파생하고, 자식 키에서 다시 손자 키를 파생할 수 있습니다.

### 2. 결정론적 생성 (Deterministic Generation)
모든 키가 단일 마스터 시드에서 결정론적으로 생성됩니다. 시드만 있으면 지갑의 모든 키를 재생성할 수 있어 백업과 복원이 간편합니다.

### 3. 확장 키 (Extended Keys)
개인키/공개키와 "체인 코드"의 조합입니다. 체인 코드는 자식 키 파생에 사용되는 추가 엔트로피입니다.

```
일반 개인키: 32 bytes
            └─ 서명만 가능

Extended Key: 개인키(32) + 체인코드(32) + 메타데이터
              └─ 서명 가능
              └─ 자식 키 파생 가능 ← 이게 핵심!
```

**직렬화 형태:**
- `xprv...` → Extended Private Key (개인키 + 체인코드)
- `xpub...` → Extended Public Key (공개키 + 체인코드)

## 파생 경로 (Derivation Path)

파일 시스템의 경로처럼 키의 위치를 표현합니다:

```
m / 44' / 0' / 0' / 0 / 0
│    │    │    │   │   │
│    │    │    │   │   └─ 주소 인덱스 (0, 1, 2...)
│    │    │    │   └───── 외부(0) / 내부(1, 잔돈용)
│    │    │    └───────── 계정 번호
│    │    └────────────── 코인 타입 (0=Bitcoin, 60=Ethereum)
│    └─────────────────── 목적 (44=BIP-44)
└──────────────────────── 마스터 키
```

**' (어포스트로피) = Hardened 파생**

### 경로 예시
| 경로 | 설명 |
|------|------|
| `m/44'/0'/0'/0/0` | Bitcoin 첫 번째 수신 주소 |
| `m/44'/0'/0'/0/1` | Bitcoin 두 번째 수신 주소 |
| `m/44'/0'/0'/1/0` | Bitcoin 첫 번째 잔돈 주소 |
| `m/44'/60'/0'/0/0` | Ethereum 첫 번째 주소 |

## Hardened vs Normal 파생

BIP-32는 두 가지 자식 키 파생 방법을 정의합니다:

| 구분 | Normal (0 ~ 2³¹-1) | Hardened (2³¹ 이상) |
|------|------------------|---------------------|
| 표기 | `m/0/1/2` | `m/0'/1'/2'` |
| 인덱스 범위 | 0 ~ 2,147,483,647 | 2,147,483,648 ~ 4,294,967,295 |
| 공개키로 자식 파생 | ✅ 가능 | ❌ 불가능 |
| 보안 | 자식 키 유출 시 부모 키 위험 | 자식 키 유출 시 부모 키 안전 |

### Unhardened (Normal) 파생
- 부모 **공개키**에서 자식 공개키 파생 가능
- Watch-only 지갑 구현 가능
- 자식 개인키가 유출되고 부모 체인코드가 알려지면 부모 개인키 계산 가능

### Hardened 파생
- 부모 **개인키**로만 자식 키 파생 가능
- 자식 키가 유출되어도 부모 키는 안전
- 계정 레벨 등 보안이 중요한 곳에 사용

### 실제 사용 패턴
```
계정 레벨 (m/44'/0'/0')    → Hardened (보안 중요)
주소 레벨 (m/44'/0'/0'/0/0) → Normal (Watch-only 지원)
```

## Watch-Only 지갑

Normal 파생의 핵심 활용 사례:

```
┌─────────────────────────────────────────────────┐
│  계정 공개키 (xpub)만 있으면                      │
│  → 모든 주소의 공개키 생성 가능                   │
│  → 잔액 확인 가능                                │
│  → 하지만 출금은 불가능 (개인키 없음)              │
└─────────────────────────────────────────────────┘
```

**사용 사례:**
- **회계 시스템**: 잔액만 모니터링
- **콜드 월렛**: 온라인에 xpub만 노출, 개인키는 오프라인 보관
- **결제 시스템**: 매번 새로운 주소 생성 (개인키 없이)

## 키 생성 과정

### 1. 마스터 키 생성

```
시드 (16-64 bytes)
        │
        ▼
┌─────────────────────┐
│ HMAC-SHA512         │
│ Key: "Bitcoin seed" │
└─────────────────────┘
        │
        ▼
┌───────────────────────────────────────┐
│     IL (32 bytes)  │  IR (32 bytes)   │
│     마스터 개인키    │  마스터 체인코드   │
└───────────────────────────────────────┘
```

### 2. 자식 키 파생

**Hardened 파생 (i ≥ 2³¹):**
```
Data = 0x00 || 부모 개인키 || i
Key  = 부모 체인코드

HMAC-SHA512(Key, Data) → IL || IR
자식 개인키 = (IL + 부모 개인키) mod n
자식 체인코드 = IR
```

**Normal 파생 (i < 2³¹):**
```
Data = 부모 공개키 || i
Key  = 부모 체인코드

HMAC-SHA512(Key, Data) → IL || IR
자식 개인키 = (IL + 부모 개인키) mod n
자식 체인코드 = IR
```

## 코드 예시

```go
// 1. 시드에서 마스터 키 생성
seed := []byte{0x00, 0x01, 0x02, ...}  // BIP-39 니모닉에서 생성
master, _ := bip32.NewMasterKey(seed)

// 2. 비트코인 첫 번째 주소 파생 (m/44'/0'/0'/0/0)
btcKey, _ := master.DeriveFromPathString("m/44'/0'/0'/0/0")
fmt.Printf("BTC Private Key: %x\n", btcKey.PrivateKeyBytes())

// 3. 이더리움 첫 번째 주소 파생 (m/44'/60'/0'/0/0)
ethKey, _ := master.DeriveFromPathString("m/44'/60'/0'/0/0")
fmt.Printf("ETH Private Key: %x\n", ethKey.PrivateKeyBytes())

// 4. Watch-only 지갑 (xpub만 사용)
accountKey, _ := master.DeriveFromPathString("m/44'/0'/0'")
xpub, _ := accountKey.Neuter()  // 공개키만 추출
fmt.Printf("Account xpub: %s\n", xpub.String())

// xpub에서 주소 파생 (개인키 없이)
external, _ := xpub.Child(0)  // m/44'/0'/0'/0
addr0, _ := external.Child(0) // m/44'/0'/0'/0/0
addr1, _ := external.Child(1) // m/44'/0'/0'/0/1
```

## 요약

| 개념 | 설명 |
|------|------|
| **시드 (Seed)** | 모든 키의 근원, 이것만 백업하면 됨 |
| **마스터 키** | 시드에서 생성된 최상위 키 |
| **파생 경로** | 키의 위치를 나타내는 경로 (예: m/44'/0'/0') |
| **Hardened (')** | 보안 강화 파생, 공개키로 자식 생성 불가 |
| **Extended Key** | 키 + 체인코드, 자식 파생 가능 |
| **xprv** | Extended Private Key, 모든 파생 가능 |
| **xpub** | Extended Public Key, Watch-only 지갑용 |

## 관련 BIP

- **BIP-39**: 니모닉 구문 (12/24 단어로 시드 생성)
- **BIP-43**: 목적 필드 정의 (m/purpose'/...)
- **BIP-44**: 다중 계정 계층 구조 (m/44'/coin'/account'/change/index)
- **BIP-49**: SegWit 호환 주소 (P2WPKH-nested-in-P2SH)
- **BIP-84**: Native SegWit 주소 (P2WPKH)

## 참고 자료

- [BIP-32 명세서](https://github.com/bitcoin/bips/blob/master/bip-0032.mediawiki)
- [본 프로젝트 구현](../pkgs/bip32/)
